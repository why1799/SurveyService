
@{
    ViewData["Title"] = "Добавление нового опроса";
}

<script src="~/lib/jquery/dist/jquery.js"></script>


<script src="~/lib/autosize-master/dist/autosize.js"></script>
<script src="~/lib/jquery-validation/dist/jquery.validate.js"></script>
<script src="~/lib/jquery-ui-1.12.1/jquery-ui.js"></script>
<script src="~/js/jquery.ddslick.min.js"></script>
<script src="~/js/polyfill.min.js"></script>
<script src="~/js/html2canvas.min.js"></script>
<link rel="stylesheet" href="~/lib/jquery-ui-1.12.1/jquery-ui.css" />
<link rel="stylesheet" href="~/css/EditCreate.css" />





<style>

    #left-menu {
        height: 85px;
    }
</style>

<div class="form-container">

    <form id="SurveyForm">
        <div style="position: relative;">
            <div id="left-menu">
                <div title="Добавить вопрос" style="background: url(/images/SurveyIcon.svg) no-repeat -2px -3168px; width: 20px; height: 24px; cursor: pointer;" onclick="AddQuestion()"></div>
                <div title="Сохранить опрос" id="savebutton" style="background: url(/images/save.svg) no-repeat; width: 20px; height: 20px; cursor: pointer;" onclick="Save()"></div>
            </div>
        </div>
        <div class="box header">

            <div class="form-input">
                <input id="SurveyName" class="surveynameinput" type="text" placeholder="" required autocomplete="off"
                       oninvalid="this.setCustomValidity('Введите название опроса')"
                       oninput="setCustomValidity('')">
                <lable class="surveynamelabel">Название опроса</lable>
            </div>
            <div class="form-input">
                <textarea id="SurveyDescription" class="surveydescriptioninput" rows="1" placeholder=""></textarea>
                <lable class="surveydescriptionlabel">Описание (не обязательно)</lable>
            </div>
        </div>

        <div id="questions">
        </div>

        <input id="submitButton" disabled class="submit" type="submit" style="display:none">

    </form>
</div>
<!--
<div style="border-bottom-style: groove; border-width: thin; margin-top:0em">
</div>
    -->

<div id="error-message" title="Ошибка сохранение!" style="display:none">
    <p>
        Необходимо добавить вопрос!
    </p>
</div>

<div id="save-message" title="Сохранение!" style="display:none">
    <p>
        Опрос сохраняется!
    </p>
    <img src="~/images/loading.gif" width="115" height="115" style="display: block;margin: 0 auto;" />
</div>


<script>

    var addedquest;
    var addedopt;

    $(document).ready(function () {
        addedquest = 0;
        addedopt = 0;
        autosize($('textarea'));
        $('#questions').sortable({
            axis: 'y',
            containment: '#questions',
            opacity: 1,
            tolerance: 'pointer'
        });
        $(window).scroll(function (e) {
            $('#left-menu').css('top', $(window).scrollTop() + 60 + 'px')
        });

        $(window).resize(function () {
            try {
                $("#save-message").dialog('widget').css({ 'margin-top': '0em' });
                $("#save-message").dialog("option", "position", { my: "top", at: "top", of: window });
                $("#save-message").dialog('widget').css({ 'margin-top': '5em' });
            }
            catch(e){ }
            try {
                $("#error-message").dialog('widget').css({ 'margin-top': '0em' });
                $("#error-message").dialog("option", "position", { my: "top", at: "top", of: window });
                $("#error-message").dialog('widget').css({ 'margin-top': '5em' });
            }
            catch(e){ }
        });

        MarginHead();
    });

    $('.surveydescriptioninput').on('input', function () {
        var $this = $(this);
        if ($this.val() == '') {
            $this.removeClass('surveydescriptioninputfilled');
        } else {
            $this.addClass('surveydescriptioninputfilled');
        }
    });


    function MarginHead() {
        if ($("#questions").children().length === 0) {
            $(".header").css("margin-bottom", "5em");
        }
        else {
            $(".header").css("margin-bottom", "");
        }

    }

    function ErrorMessage() {

        $("#error-message").dialog({
            width: 280,
            height: 150,
            resizable: false,
            modal: true,
            draggable: false,

            closeOnEscape: false,
            open: function (event, ui) {
                $(event.target).dialog('widget')
                    .css("box-shadow", "0 10px 28px rgba(0,0,0,0.25), 0 0px 10px rgba(0,0,0,0.22)")
                    .css("border-radius", "10px")
                    .css({ position: 'fixed' })
                    .position({ my: 'top', at: 'top', of: window })
                    .css({ 'margin-top': '5em' });
                $(".ui-dialog-titlebar-close", ui.dialog | ui).hide();
            },

            close: function (event, ui) {
                $(event.target).dialog('widget')
                    .css({ 'margin-top': '0em' });
            },

            buttons: {
                Ok: function () {
                    $(this).dialog("close");
                }
            }
        });
    }

    function SaveMessage() {

        $("#save-message").dialog({
            width: 280,
            height: 205,
            resizable: false,
            modal: true,
            draggable: false,

            closeOnEscape: false,
            open: function (event, ui) {
                $(event.target).dialog('widget')
                    .css("box-shadow", "0 10px 28px rgba(0,0,0,0.25), 0 0px 10px rgba(0,0,0,0.22)")
                    .css("border-radius", "10px")
                    .css({ position: 'fixed' })
                    .position({ my: 'top', at: 'top', of: window })
                    .css({ 'margin-top': '5em' });
                $(".ui-dialog-titlebar-close", ui.dialog | ui).hide();
            },

            close: function (event, ui) {
                $(event.target).dialog('widget')
                    .css({ 'margin-top': '0em' });
            }
        });
    }

    function MakeSelectSlick(selectid) {
        $('#' + selectid).ddslick({
            width: 200,
            onSelected: function (selectedData) {
                var selectid = selectedData.original[0].id;
                var questid = $("#" + selectid).parent().parent().parent()[0].id;
                if (selectedData.selectedIndex === 0) {
                    $("#options" + questid).empty();
                    $("#" + questid + " #ratingoption").hide();
                    $("#" + questid + " #another").hide();
                    $("#" + questid + " #addnew").hide();
                    $("#" + questid + " #addnew label").show();
                    $("#" + questid + " #textoption").show();
                }
                else if (selectedData.selectedIndex === 1) {
                    if ($("#" + questid + " #ratingoption").css("display") != "flex") {
                        $("#options" + questid).empty();
                        $("#" + questid + " #another").hide();
                        $("#" + questid + " #addnew").hide();
                        $("#" + questid + " #textoption").hide();
                        $("#" + questid + " #addnew label").show();
                        $("#" + questid + " #ratingoption").show();
                        $("#" + questid + " #ratingoption #minselect").ddslick('select', { index: 1 });
                        $("#" + questid + " #ratingoption #maxselect").ddslick('select', { index: 3 });
                    }
                }
                else if (selectedData.selectedIndex === 2) {
                    $("#" + questid + " #ratingoption").hide();
                    $("#" + questid + " #textoption").hide();
                    $("#" + questid + " #addnew").show();
                    $("#" + questid + " #image").attr("src", "/images/radioboxoptions.png");
                }
                else if (selectedData.selectedIndex === 3) {
                    $("#" + questid + " #ratingoption").hide();
                    $("#" + questid + " #textoption").hide();
                    $("#" + questid + " #addnew").show();
                    $("#" + questid + " #image").attr("src", "/images/checkboxoptions.png");
                }
            }
        });

    }

function RemoveSurvey(surveyid) {
        $.ajax({
            url: "/Admin/RemoveSurvey",
            type: "GET",
            data: { id: surveyid },
            success: function (data) {
                window.location.href = '@Url.Action("Surveys", "Admin")';
            }
        });
    }

    function AddAnother(id) {
        $("#" + id + " #another").show();
        $("#" + id + " #addnew label").hide();
    }

    function RemoveAnother(id) {
        $("#" + id + " #another").hide();
        $("#" + id + " #addnew label").show();
    }

    function AddQuestion() {


        var newquestion = "\
<div id=\"newquest{ID}\" class=\"box\" style=\"margin-top:1em;\">\
\
    <div style=\"justify-content: center;display: flex;margin-top:1em;\">\
        <img id=\"movenewquest{ID}\" src=\"/images/questiondots.png\" style=\"cursor:move;\" width=\"20\" height=\"10\">\
    </div>\
\
\
    <div class=\"question-settings\">\
        <div class=\"leftdiv\" style=\"position: relative;\">\
            <textarea rows=\"1\" class=\"questiontitleinput\" type=\"text\" placeholder=\"\" required oninvalid=\"this.setCustomValidity('Введите название вопроса')\" oninput=\"setCustomValidity('')\"></textarea>\
            <label class=\"questiontitlelabel\">Название вопроса</label>\
        </div>\
        <div class=\"rightdiv\">\
            <select id=\"newquest{ID}select\" style=\"width:100%;display:none;\">\
                <option value=\"0\" data-imagesrc=\"/images/text.png\" data-description=\" \">Текст</option>\
                <option value=\"1\" data-imagesrc=\"/images/star.png\" data-description=\" \">Рейтинг</option>\
                <option value=\"2\" selected=\"selected\" data-imagesrc=\"/images/radiobox.png\" data-description=\" \">Один из списка</option>\
                <option value=\"3\" data-imagesrc=\"/images/checkbox.png\" data-description=\" \">Несколько из списка</option>\
            </select>\
        </div>\
    </div>\
\
    <div id=\"optionsnewquest{ID}\" name=\"options\">\
    </div>\
\
    <div id=\"textoption\" style=\"margin-top:1em;margin-left:5%;display:none\">\
        <input style=\"width:94.5%;height: 30px;font-size: 15px;\" disabled type=\"text\" placeholder=\"Текстовый ответ\">\
    </div>\
\
        <div id=\"ratingoption\" style=\"display:none\" class=\"ratingoption\">\
                    <div class=\"minselectdiv\">\
                        <select id=\"minselect\" class=\"minselect\">\
                            <option>0</option>\
                            <option>1</option>\
                        </select>\
                    </div>\
                    <label style=\"margin-left:1em;\">—</label>\
                    <div class=\"maxselectdiv\">\
                        <select id=\"maxselect\" class=\"maxselect\">\
                            <option>2</option>\
                            <option>3</option>\
                            <option>4</option>\
                            <option>5</option>\
                            <option>6</option>\
                            <option>7</option>\
                            <option>8</option>\
                            <option>9</option>\
                            <option>10</option>\
                        </select>\
                    </div>\
                </div>\
\
    <div id=\"another\" style=\"display:none;\">\
        <img id=\"image\" src=\"/images/radioboxoptions.png\" width=\"20\" height=\"20\" style=\"margin-left:5%;\">\
        <input class=\"option-input\" style=\"width:87%;\" disabled type=\"text\" placeholder=\"Другое...\">\
        <div title=\"Удалить другое\" name=\"picture\" style=\"background: url('/images/SurveyIcon.svg') no-repeat -5px -4061px; width: 14px; height: 14px; zoom:1.4; cursor: pointer;\" onclick=\"RemoveAnother('newquest{ID}')\"></div>\
    </div>\
\
\
    <div id=\"addnew\" class=\"addnew\" style=\"margin-top:1em\">\
        <img id=\"image\" src=\"/images/radioboxoptions.png\" width=\"20\" height=\"20\" style=\"margin-left:5%;\">\
        <input style=\"height: 30px;font-size: 15px;width:127px\" type=\"text\" placeholder=\"Добавить вариант\" onclick=\"AddOption('newquest{ID}')\"  onkeydown=\"OnChangeAdd('newquest{ID}')\">\
        <label style=\"display:normal;font-weight:normal\"> или <a style=\"cursor:pointer;font-weight:bold\" onclick=\"AddAnother('newquest{ID}')\">ДОБАВИТЬ ВАРИАНТ \"ДРУГОЕ\"</a></label>\
    </div>\
\
    <div class=\"hl\" style=\"margin-top:1em;\"></div>\
\
    <div class=\"beforequestionfooter\"></div>\
    <div class=\"questionfooter\" style=\"margin-top:0.5em;margin-bottom:0.5em;\">\
        <div title=\"Удалить вопрос\" name=\"picture\" style=\"background: url(/images/SurveyIcon.svg) no-repeat -5px -1203px; width: 14px; height: 18px;margin-right:2em;cursor: pointer;\" onclick=\"RemoveQuestion('newquest{ID}')\"></div>\
        <div class=\"vl\" style=\"margin-right:2em\"></div>\
        <div style=\"margin-right:0.5em\">\
            <label style=\"color:rgba(51, 51, 51, 0.78);\">Обязательный вопрос</label>\
        </div>\
        <div>\
            <input type=\"checkbox\" id=\"newquest{ID}required\" style=\"display:none\" />\
            <label for=\"newquest{ID}required\" class=\"toggle\"><span name=\"span\"></span></label>\
        </div>\
    </div>\
\
</div>\
";
        newquestion = newquestion.replace("{ID}", addedquest)
            .replace("{ID}", addedquest)
            .replace("{ID}", addedquest)
            .replace("{ID}", addedquest)
            .replace("{ID}", addedquest)
            .replace("{ID}", addedquest)
            .replace("{ID}", addedquest)
            .replace("{ID}", addedquest)
            .replace("{ID}", addedquest)
            .replace("{ID}", addedquest)
            .replace("{ID}", addedquest);


        $("#questions").append(newquestion);
        $('#newquest' + addedquest + ' #minselect').ddslick({
            width: 200,
            onSelected: function (selectedData) {
            }
        });

        $('#newquest' + addedquest + ' #maxselect').ddslick({
            width: 200,
            onSelected: function (selectedData) {
            }
        });
        MakeSelectSlick('newquest' + addedquest + 'select');
        autosize($('#newquest' + addedquest + ' div div textarea'));
        $('#optionsnewquest' + addedquest).sortable({
            axis: 'y',
            containment: '#optionsnewquest' + addedquest,
            opacity: 1,
            tolerance: 'pointer'
        });

        addedquest++;

        MarginHead();
    }

    function RemoveQuestion(surveyquestionid) {
        $("#" + surveyquestionid).remove();
        MarginHead();
    }

    function AddOption(surveyquestionid) {
        AddOptionText(surveyquestionid, "");
    }

    function AddOptionText(surveyquestionid, text) {
        var newoption = "\
                <div id=\"newopt{ID}\" class=\"optionseparation\">\
\
                                <div class=\"optionleft\">\
                                    <img id=\"movenewopt{ID}\" src=\"/images/optiondots.png\" width=\"10\" height=\"20\" style=\"cursor:move;\">\
                                </div>\
\
                                <div class=\"optionright\">\
                                    <img id=\"image\" src=\"{TYPE}\" width=\"20\" height=\"20\">\
                                    <input class=\"option-input\" type=\"text\" placeholder=\"Ответ\" required=\"\" oninvalid=\"this.setCustomValidity('Введите ответ')\" oninput=\"setCustomValidity('')\" value=\"\">\
                                    <div title=\"Удалить ответ\" name=\"picture\" style=\"background: url('/images/SurveyIcon.svg') no-repeat -5px -4061px; width: 14px; height: 14px; zoom:1.4; cursor: pointer;\" onclick=\"RemoveOption('newopt{ID}')\"></div>\
                                </div>\
\
                            </div>";

        newoption = newoption.replace("{ID}", addedopt)
            .replace("{ID}", addedopt).replace("{ID}", addedopt).replace("{TYPE}", $("#" + surveyquestionid + " #addnew #image").attr('src'));

        $("#options"+ surveyquestionid).append(newoption);

        $('#newopt' + addedopt + ' input').val(text);
        $('#newopt' + addedopt + ' input').focus();

        $("#" + surveyquestionid + " #addnew input")[0].setCustomValidity('');

        addedopt++;
    }

    function OnChangeAdd(surveyquestionid) {
        var val = $("#" + surveyquestionid + " #addnew input").val();
        $("#" + surveyquestionid + " #addnew input").val("");
        AddOptionText(surveyquestionid, val);
    }

    function RemoveOption(optionid) {
        $("#" + optionid).remove();
    }

    function Save() {

        if (!$('#SurveyForm')[0].checkValidity()) {
            $("#submitButton").prop("disabled", false);
            $('#submitButton').click();
            $("#submitButton").prop("disabled", true);
            return;
        }

        SaveMessage();

        var title = $("#SurveyName").val();
        var description = $("#SurveyDescription").val();

        var questions = [];

        var questiondivs = $("#questions").children();

        for (var i = 0; i < questiondivs.length; i++) {
            var question = [];
            var id = questiondivs[i].id;
            question.push(id);
            question.push($("#" + id + " div div textarea").val());

            var select = $("#" + id + "select").data('ddslick').selectedIndex;;
            var type;
            if (select === 0) {
                type = "2"
            }
            else if (select === 1) {
                type = "3"
            }
            else if (select === 2) {
                type = "0"
            }
            else if (select === 3) {
                type = "1"
            }

            question.push(type);

            if ($('#' + id + ' #addnew label').css('display') == 'none') {
                question.push("True");
            }
            else {
                question.push("False");
            }

            if ($("#" + id + "required")[0].checked) {
                question.push("True");
            }
            else {
                question.push("False");
            }
            if (select === 1) {
                var minselect = $("#" + id + " #minselect").data('ddslick').selectedIndex;
                var maxselect = $("#" + id + " #maxselect").data('ddslick').selectedIndex + 2;
                for (var j = minselect; j <= maxselect; j++) {
                    question.push("newoption" + j);
                    question.push(j);
                }
            }
            if (select === 2 || select === 3) {
                var options = $("#options" + id).children();
                for (var j = 0; j < options.length; j++) {
                    var optionid = options[j].id;
                    question.push(optionid);
                    question.push($("#" + optionid + " div input").val());
                }
            }
            questions.push(question);
        }

        if (questions.length == 0) {
            $("#save-message").dialog("close");
            $("#savebutton").effect("bounce");
            ErrorMessage();
            return;
        }

        for (var i = 0; i < questions.length; i++) {
            if (questions[i].length <= 5 && questions[i][2] != "2") {
                $("#" + questions[i][0] + " #addnew input")[0].setCustomValidity('Необходимо добавить ответ');
            }

            if (questions[i][2] === "2") {
                $("#" + questions[i][0] + " #addnew input")[0].setCustomValidity('');
            }
        }

        if (!$('#SurveyForm')[0].checkValidity()) {
            $("#save-message").dialog("close");
            $("#submitButton").prop("disabled", false);
            $('#submitButton').click();
            $("#submitButton").prop("disabled", true);
            return;
        }


        /* var div = "<div id=\"screenshot\"></div>";
         $("body").append(div);
         //$("#screenshot").css("display", "none");
         $("#screenshot").css("width", "1000px");
         $("#screenshot").css("height", "1000px");
         $("#screenshot").append($("body").clone());
         $("#screenshot #left-menu").remove();*/

        $("span[name=span]").each(function () {
             var a = $(this).css('transform');
             if (a.indexOf("20") >= 0) {
                 $(this).css('transform', 'translateX(10px)');
             }

         })



        html2canvas(document.body.querySelector(".container.body-content"),  {
            onclone: function (clonedDoc) {
                $(".addnew", $(clonedDoc)).each(function () {
                    $(this).css('display', 'none');
                })

                $('.questionfooter', $(clonedDoc)).each(function () {
                    $(this).css('display', 'none');
                })

                $('.hl', $(clonedDoc)).each(function () {
                    $(this).css('display', 'none');
                })

                $(".beforequestionfooter", $(clonedDoc)).each(function () {
                    $(this).css('display', 'block');
                })

                $('#left-menu', $(clonedDoc)).remove();
                $(".container.body-content", $(clonedDoc)).css("zoom", "4");
                $(".container.body-content", $(clonedDoc)).css("width", "1000px");
                $(".container.body-content", $(clonedDoc)).css("height", "1000px");
                var color = $("body").css("background-color");
                $(".container.body-content", $(clonedDoc)).css("background-color", color);

                $("div[name=picture]", $(clonedDoc)).each(function () {
                    $(this).css('zoom', '1');
                })
            }
        }).then(function (canvas) {

            $("span[name=span]").each(function () {
                var a = $(this).css('transform');
                if (a.indexOf("10") >= 0) {
                    $(this).css('transform', '');
                }
            })

            canvas = crop(canvas, { x: 0, y: 0 }, { x: 1000, y: 1000 });

            var img = canvas.toDataURL("image/png");
            img = img.replace('data:image/png;base64,', '');


            $.ajax(
            {
                url: '/Admin/Save',
                type: "POST",
                data: {'title': title, 'description': description, 'lines': questions, 'image':img },
                success: function (data) {
                    var url = '@Url.Action("Edit", "Admin", new { id = "--ID--" })';
                    url = url.replace("--ID--", data.id);
                    window.location.href = url;
                },
                error: function () {
                    $("#save-message").dialog("close");
                }
            });
        });
    }

    function crop(can, a, b) {
        // get your canvas and a context for it
        var ctx = can.getContext('2d');

        // get the image data you want to keep.
        var imageData = ctx.getImageData(a.x, a.y, b.x, b.y);

        // create a new cavnas same as clipped size and a context
        var newCan = document.createElement('canvas');
        newCan.width = b.x - a.x;
        newCan.height = b.y - a.y;
        var newCtx = newCan.getContext('2d');

        // put the clipped image on the new canvas.
        newCtx.putImageData(imageData, 0, 0);

        return newCan;
    }


</script>

